{% extends 'base.html.twig' %}

{% block title %}Carte des hôtels - MatchRoom{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <style>
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hotel-popup .hotel-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #3A2E27;
            margin-bottom: 5px;
        }
        .hotel-popup .hotel-address {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }
        .hotel-popup .hotel-description {
            font-size: 0.85em;
            margin-top: 5px;
        }
        .map-container {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .map-header {
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block body %}
<div class="min-h-screen flex flex-col">
    <!-- Navbar -->
    {% include 'partials/_navbar.html.twig' %}

    <!-- Contenu principal -->
    <div class="container mx-auto px-4 py-8">
        <div class="map-container">
            <div class="map-header">
                <h1 class="text-2xl font-serif font-bold text-primary-700 mb-2">Carte des hôtels</h1>
                <p class="text-gray-600">Découvrez tous les hôtels partenaires de MatchRoom sur la carte interactive</p>
            </div>
            
            <div id="map"></div>
            
            <div class="mt-4 text-sm text-gray-500">
                <p>Cliquez sur un marqueur pour voir les détails de l'hôtel.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser la carte centrée sur la France
            const map = L.map('map').setView([46.603354, 1.888334], 6);
            
            // Ajouter la couche de carte OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Récupérer les données des hôtels depuis l'API
            fetch('{{ path('app_map_hotels_data') }}')
                .then(response => response.json())
                .then(hotels => {
                    if (hotels.length === 0) {
                        // Afficher un message si aucun hôtel n'a de coordonnées
                        const noHotelsDiv = document.createElement('div');
                        noHotelsDiv.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mt-4';
                        noHotelsDiv.innerHTML = '<p>Aucun hôtel avec des coordonnées géographiques n\'est disponible pour le moment.</p>';
                        document.querySelector('.map-container').appendChild(noHotelsDiv);
                        return;
                    }
                    
                    // Créer un groupe pour les marqueurs
                    const markers = L.featureGroup();
                    
                    // Ajouter un marqueur pour chaque hôtel
                    hotels.forEach(hotel => {
                        const marker = L.marker([hotel.latitude, hotel.longitude])
                            .bindPopup(`
                                <div class="hotel-popup">
                                    <div class="hotel-name">${hotel.name}</div>
                                    <div class="hotel-address">${hotel.address}</div>
                                    <div class="hotel-description">${hotel.description || 'Aucune description disponible'}</div>
                                </div>
                            `);
                        
                        // Ajouter un événement de clic sur le marqueur
                        marker.on('click', function() {
                            // Zoomer au maximum sur le point GPS de l'hôtel
                            map.setView([hotel.latitude, hotel.longitude], 18);
                            // Ouvrir la popup après un court délai pour laisser le temps au zoom de s'effectuer
                            setTimeout(() => marker.openPopup(), 300);
                        });
                        
                        markers.addLayer(marker);
                    });
                    
                    // Ajouter le groupe de marqueurs à la carte
                    markers.addTo(map);
                    
                    // Ne pas ajuster automatiquement la vue pour conserver la vue initiale de la France
                    // La vue initiale est déjà définie avec setView([46.603354, 1.888334], 6)
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des hôtels:', error);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mt-4';
                    errorDiv.innerHTML = '<p>Une erreur est survenue lors du chargement des données des hôtels.</p>';
                    document.querySelector('.map-container').appendChild(errorDiv);
                });
        });
    </script>
{% endblock %}
